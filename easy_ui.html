<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sd_api调用</title>
</head>

<body>
    <style>
        :root {
        --backgroung_color: rgb(13, 17, 23);
        --fontColor: white
        }
        .textarea_c{
            font-family: "Helvetica Neue",Helvetica,"PingFang SC","Hiragino Sans GB","Microsoft YaHei","微软雅黑",Arial,sans-serif;
        }
        *{
            background-color: var(--backgroung_color);
            color: var(--fontColor);
        }
        #generate_button{
            padding: 15px 32px;
            background-color: blueviolet;
            border-radius: 8px;
            display: inline-block;
            cursor: pointer;
        }
        
    </style>
    <div id="txt2img" style="margin-bottom: 20px;">
        <textarea style="width: 100%;" rows="8" placeholder="正面prompt" id="p_prompt" class="textarea_c">masterpiece, best quality, </textarea>
        <textarea style="width: 100%;" rows="8" placeholder="负面prompt" id="n_prompt" class="textarea_c">EasyNegative, </textarea>
        <span>宽度: </span><input type="number" min="8" value="512" placeholder="width" id="width">
        <span>长度: </span><input type="number" min="8" value="768" placeholder="height" id="height">
        <span>提示词相关性: </span><input type="number" min="1" value="11" placeholder="提示词相关性(cfg_scale)" id="cfg_scale">
        <span>步数: </span><input type="number" min="1" value="24" placeholder="steps" id="steps">
        <span>种子: </span><input type="number" value="-1" min="-1" placeholder="seed" id="seed"/>
    </div>
    <div style="margin-bottom: 20px;">
        <span>采样方法: <select id="sampler_index">
            <option>Euler</option>
            <option>Euler a</option>
            <option>DPM++ 2M</option>
            <option selected>DPM++ 2M Karras</option>
            <option>DPM++ 2M SDE</option>
            <option>DPM++ 2M SDE Karras</option>
            <option>DPM++ 2M SDE Exponential</option>
            <option>DPM++ 2M SDE Heun</option>
            <option>DPM++ 2M SDE Heun Karras</option>
            <option>DPM++ 2M SDE Heun Exponential</option>
            <option>DPM++ 3M SDE</option>
            <option>DPM++ 3M SDE Karras</option>
            <option>DPM++ 3M SDE Exponential</option>
            <option>DPM++ SDE Karras</option>
        </select></span>
    </div>
    <div>
        <button onclick="hr_pic()" id="hr_button" style="margin-right: 20px;">高清修复(关)</button>
        <span>放大倍数: </span><input type="number" min="1" step="0.1" value="2" id="magnification"/>
        <span>重回幅度: </span> <input type="number" min="0.01" step="0.01" value="0.6" id="denoising_strength"/>
        <span>放大算法: <select id="hr_upscaler"></select></span>
    </div>
    <div style="position:relative;top:10px;text-align: center;">
        <button onclick="txt2img()" id="generate_button">生成</button>
    </div>
    <div id="show_img"></div>

    <script>
        function setUpscalers() {
            const xhr = new XMLHttpRequest();
            xhr.open("get","/callInterface/api/upscalers",true)
            xhr.onload = function(){
                const upscalers = this.responseText.replaceAll('"','').split(',')
                for (upscaler in upscalers) {
                    let upscaler_option = document.createElement("option");
                    upscaler_option.innerText = upscaler;
                    document.getElementById("hr_upscaler").appendChild(upscaler_option,document.getElementById("hr_upscaler").firstChild);
                }
            }
            xhr.send();
        }
        let is_hr = false;
        function hr_pic() {
            const hr_button = document.getElementById("hr_button");
            if (hr_button.innerText === "高清修复(关)") {
                hr_button.innerText = "高清修复(开)";
                is_hr = true;
            }else{
                hr_button.innerText = "高清修复(关)";
                is_hr = false;
            }
        }
        let backgroung_color,fontColor;
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches || window.location['href'].endsWith('__theme=dark')) {
            backgroung_color = "rgb(13, 17, 23)";
            fontColor = "white";
        }else{
            backgroung_color = "white";
            fontColor = "black";
        }
        const show_img_div = document.getElementById("show_img");

        function txt2img() {
            const n_prompt = document.getElementById("n_prompt").value;
            const p_prompt = document.getElementById("p_prompt").value;
            const cfg_scale = document.getElementById("cfg_scale").value;
            const steps = document.getElementById("steps").value;
            const width = document.getElementById("width").value - document.getElementById("width").value % 8;
            const height = document.getElementById("height").value - document.getElementById("height").value % 8;
            const sampler_index = document.getElementById("sampler_index").options[document.getElementById("sampler_index").selectedIndex].text;
            let seed = document.getElementById("seed").value;
            seed = (seed == '0' || seed == '-1') ? seed = Math.random().toString().slice(9) : seed
            param = {
                "prompt":p_prompt,
                "negative_prompt":n_prompt,
                "seed":seed,
                "cfg_scale":cfg_scale,
                "steps":steps,
                "width":width,
                "height":height,
                "sampler_index":sampler_index,

            };
            if (is_hr) {
                param["enable_hr"] = true;
                param["hr_scale"] = document.getElementById("magnification").value;
                param["denoising_strength"] = document.getElementById("denoising_strength").value;
                param["hr_upscaler"] = document.getElementById("hr_upscaler").options[document.getElementById("hr_upscaler").selectedIndex].text;
            }
            const xhr = new XMLHttpRequest();
            const url =  '/callInterface/api/txt2img';
            xhr.open("post", url,true);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            xhr.onload = function () {
                if (this.status == 200) {
                    const img = document.createElement("img");
                    img.style.maxWidth = "512px";
                    img.src = "data:image/png;base64," + this.responseText.replaceAll('"','');
                    show_img_div.insertBefore(img,show_img_div.firstChild);
                }else{
                    alert("error: "+this.responseText)
                }
                
            }
            xhr.send(JSON.stringify(param));

        };
    </script>
</body>

</html>
